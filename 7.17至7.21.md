# 7月17日至7月21日周报

周一，组长主要先给我们介绍了一下**吉致批售资产管理系统**这个项目，整体采用Avue以及springcloud编写的。开始主要是先整体的跑一遍服务，根据组长提前给好的文档，自己运行测试一遍。





## 配置虚拟机

这个项目中的用到的mysql和redis都是在Linux中跑的，所以首先是将这个虚拟机安装到自己本地。



### MySQL报错

在使用数据库管理工具连接虚拟机的mysql时，发现系统报了一个如下错误：

![image-20230721214620577](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230721214620577.png)

在网上查询这个问题之后发现：**mysql5.7的加密方式默认是方式是mysql_native_password，mysql8.0的加密方式默认是caching_sha2_password。**而我自己的navicat支持的数据库版本是5.7的，但是虚拟机中使用的mysql版本是最新的mysql8，所以导致连接认证失败。

#### 解决办法

进入mysql终端，输入如下命令：`alter user ‘root’@localhost identified with mysql_native_password by ‘Pccw1234.’`，修改mysql加密规则后，就能正常连接了





### 修改IP

修改虚拟机IP是因为虚拟机默认的ip是通过dhcp动态获取，所以每次开启虚拟机的时候，ip可能会发生变化，这时无论是redis、mysql的管理工具还是Finalshell的连接都会失败，这时就得修改这些管理工具的配置信息，比较麻烦。



#### 解决方法

将虚拟机的IP设置为静态的，让它每次启动的IP都是固定的

首先使用`vim /etc/sysconfig/network-scripts/ifcfg-ens33`编辑配置信息

![image-20230721221346687](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230721221346687.png)



之后，在VMware的虚拟网络编辑器中配置如下信息：

![image-20230721221608729](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230721221608729.png)

之后启动虚拟机，IP就不会发生变化了





## 修改host文件

首先是修改系统host文件，这里面vsn-mysql和vsn-redis的地址要配置成自己虚拟机的地址

```shell
127.0.0.1 vsn-register
127.0.0.1 vsn-gateway
172.25.140.134 vsn-mysql
127.0.0.1 vsn-auth
172.25.140.134 vsn-redis

```

我一开始是并没有修改这个host文件，导致最后服务运行的时候老是报错，大概意思是找不到具体的url路径，最后核实一遍后发现是第一步的系统host文件没有修改

![image-20230721230647816](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230721230647816.png)







## 生成代码

首先进入到xcloud-gen目录，先检查自己maven`mvn -v`，之后执行`mvn clean install`，安装服务的jar包到本地的maven仓库



之后自己先建一个文件夹用于存放代码，进入该文件夹下，使用如下命令生成微服务：

服务报名是自己定义的名字，以下命令是一行命令。

```shell
mvn archetype:generate -DgroupId=com.pccw -DartifactId=vsn-服务包名 -Dversion=1.0.0-SNAPSHOT -Dpackage=com.pccw.vsn.服务包名 -DarchetypeGroupId=com.pccw.archetype -DarchetypeArtifactId=xcloud-gen -DarchetypeVersion=4.1.0 -DarchetypeCatalog=local

```

在生成代码时要注意的就是：那些**脚本命令不能在powershell中使用**，我电脑默认打开的终端是powershell，我在powershell中使用该脚本时一直报错，后来换到cmd窗口下，就可以顺利执行了



新建好之后的样子应该是这样的：(kevin是我自己定义的服务包名)

![image-20230724101106822](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230724101106822.png)



打开如图所示的vsn-kevin-biz，将里面的bootstrap.yml改为如下内容：

```yml
erver:
  port: 6901

spring:
  application:
    name: @artifactId@
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_HOST:vsn-register}:${NACOS_PORT:8848}
        metadata: { "VERSION": "1.0" }
        namespace: vsn-${spring.profiles.active}
      config:
        server-addr: ${spring.cloud.nacos.discovery.server-addr}
        file-extension: yml
        shared-configs:
          - application-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}
        namespace: vsn-${spring.profiles.active}
      username: ${NACOS_USER:nacos}
      password: ${NACOS_PWD:nacos}
    inetutils:
      preferred-networks:
        - 10.8
  autoconfigure:
    exclude: org.springframework.cloud.gateway.config.GatewayAutoConfiguration,org.springframework.cloud.gateway.config.GatewayClassPathWarningAutoConfiguration
  profiles:
    active: @profiles.active@
xcloud:
  xsequence:
    db:
      retry-times: 3
      table-name: xcloud_sequence
      step: 1
      step-start: 30

```







### nacos配置

在nacos中新建配置，配置的 DataID 格式为 vsn-服务包名-biz-环境标识.yml。例如：vsn-kevin-biz-dev.yml

注意：**命名空间要在vsn-dev下**，不能建在public下面，否则idea运行程序时会报错

```yaml
## spring security config
security:
  oauth2:
    client:
      client-id: ENC(ltJPpR50wT0oIY9kfOe1Iw==)
      client-secret: OS0sVWcU12RxLMaa
      scope: server
      ignore-urls:
        - /druid/**
        - /actuator/**
        - /api/**
        - /v2/api-docs

# datasource config
spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    druid:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://vsn-mysql:5326/crrcdb?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
      username: vsnadmin
      password: vsn2023!
      max-active: 32
      stat-view-servlet:
        enabled: true
        allow: ""
        url-pattern: /druid/*
        login-username: admin
        login-password: admin
      filter:
        stat:
          enabled: true
          log-slow-sql: true
          slow-sql-millis: 10000
          merge-sql: false
        wall:
          config:
            multi-statement-allow: true
    dynamic:
      druid:
        connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000
        filters: stat,slf4j
        initial-size: 5
        maxActive: 32
        maxWait: 60000
        min-idle: 0
        minEvictableIdleTimeMillis: 300000
        stat-view-servlet:
          allow: ''
          reset-enable: false
          url-pattern: /druid/*
          login-username: admin
          login-password: admin
        testOnBorrow: false
        testOnReturn: false
        testWhileIdle: true
        removeAbandoned: false
        timeBetweenEvictionRunsMillis: 60000
        #validationQuery: SELECT 'x'
        web-stat-filter:
          enabled: true
          exclusions: '*.js,*.gif,*.jpg,*.bmp,*.png,*.css,*.ico,/druid/*'
          url-pattern: /*

# Logger Config
logging:
  level:
    com.pccw.vsn.服务名.mapper: debug
    org.apache.ibatis.session: debug

xcloud:
  sql:
    use-camel-case-mapping: true
    res-upper-case: true
    api-has-pre: true   
```

把mysql的用户名密码和日志配置中的服务名改成自己的，或者也可以直接克隆nacos中之前的配置文件，然后只改日志配置中的服务名





有时候在程序启动的时候也会报错，需要在运行配置的程序参数里面加上这样一段参数：

![image-20230721223922719](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230721223922719.png)

==关于这行参数，有时候不加不会报错，有时候不加程序就会报错，所以最好还是加上==





## JDK版本

关于jdk的版本，**一定要使用Oracle的jdk**，使用idea自带的jdk的话，会出现很多错误



在这个项目里，我最开始用的是idea自带的jdk8，结果运行出现了如下错误：

![image-20230721224236061](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230721224236061.png)



**解决办法：**将整个项目的jdk版本换成Oracle的jdk







在最开始项目运行时，程序报了如下错误，后来发现也是因为jdk的版本问题，换成Oracl的jdk之后就不报错了：

![image-20230721225350979](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230721225350979.png)





**解决方法：**在运行配置里的VM options中加入如下参数：

`--add-opens java.base/java.util=ALL-UNNAMED --add-opens java.base/java.lang=ALL-UNNAMED`

![image-20230721225123511](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230721225123511.png)







## 前台登录

在idea中打开终端，进入vsn-ui文件夹，然后运行命令`npm run dev`

在给的资料中，进入xcloud的bin文件夹下，运行那六个bat文件时，**每个文件的启动时间不能设置的太短**

由于电脑配置原因，如果将启动时间改的太快，可能会导致前端页面无法登录或者图片验证码无法加载出来

开始我设置的每个文件的启动时间是6秒，服务启动完成之后，在前端点击登录按钮，一直登陆不上去，有时重新刷新之后，那个图片验证码也无法加载

最后发现是因为把文件的的启动时间设置的太短了，有些文件可能还没有执行完就到下一个文件了，所以导致前台登录一直在转圈





## 动态路由

进入系统管理-动态路由，点击最后一个配置前面的方块，在弹出的菜单里面选择复制配置

![image-20230724102102248](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230724102102248.png)





复制之前的配置，然后修改如下信息：

其中vsn-kevin-biz是自己的模块名

![image-20230722110856850](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230722110856850.png)

修改完成之后，点击更新，只要系统提示更新成功即可！



之后将代码复制到工程目录，将启动类的名字修改为Vsn服务报名，采用驼峰命名法

![image-20230724102253309](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230724102253309.png)

![image-20230724102322026](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230724102322026.png)









## 功能代码生成

首先设计表，字段同意采用大写，单词之间采用下划线分割，表名格式：vsn_微服务包名_业务名

![image-20230724102617329](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230724102617329.png)

类型：其中ID为 varchar(50) , NAME 为 varchar(120) , TIME 为 DATETIME



数据库表设计好之后，打开前台页面:开发平台-代码生成，找到自己设计的表，点击生成

包名统一为 com.pccw.vsn

作者名为 开发者的英文或者汉语拼音，如：kevin

模块名为 微服务包名 如 kevin

api前缀也为 微服务名 如 vsn-kevin

表前缀为 vsn_



后端代码：

注意：将xcloud文件夹下的src目录要**覆盖**自己biz模块原来的src目录，如果直接复制的话有时会导致自己原来的启动类不见了

所以，这一步覆盖最稳妥的办法就是：**把xcloud文件夹下src每个目录下的文件手动粘到自己原来对应的biz模块中**

前端代码：

打开 xcloud-front 打开api，将api下的文件夹 放到 vsn-ui/src/api/vsn 下

将views目录下的文件夹复制到vsn-ui/src/views/vsn目录下

将const目录下的js复制到上一步views中index.vue的同级目录

在index.vue中修改引用路径



**注意：关于这里的引入路径**

![image-20230721233622255](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230721233622255.png)

第二项如果采用上述路径看似没有问题，但是ctrl+鼠标左键点击的时候，发现并点不进去，开始并没有注意这件事情，后来前后端一块运行之后，后端控制台老是报错：

![image-20230721233927203](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230721233927203.png)



**解决方法**：必须采用以下写法：`import {tableOption} from './kevinleave'`







## 配置菜单

在配置菜单这里，里面的路由路径就是自己前端页面中，以src/views目录下的vsn文件夹开头的，写的是index.vue的路径

菜单配置完之后，要添加功能按钮，**功能按钮中的权限标识对应index.vue中定义的权限**

![image-20230721234657909](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230721234657909.png)



![image-20230722111039334](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230722111039334.png)











## 菜单权限

在菜单和按钮配置好之后，需要对其进行授权，才能在列表中显示

前端页面中点击：权限管理-角色管理。选择超级用户，点击后面的权限

![image-20230724103159561](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230724103159561.png)



![image-20230722111119936](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230722111119936.png)











## 流程开发

登录到前台页面后，点击：开发平台-流程定义

这个流程的作用大概就是：给这个系统指定运行方向，告诉这个系统到哪个节点该干什么事情。

比如说：流程运行到了业务A，这个业务的具体实现是在微服务里面定义开发的，流程只需要关心系统要干什么，但是具体怎么干流程并不关心。

**大概就是：流程——>前端页面——>调用后端方法**





![image-20230722115312457](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230722115312457.png)

**这里的流程key在后面会用到，所以要记住**



例如：在新增请假页面之后，在index页面中要新增三个按钮，用于新增、查看或者编辑请假，给这三个按钮都定义一个click事件，在单击该按钮之后触发handleStartProcess方法

![image-20230722163033067](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230722163033067.png)

这个方法用于处理启动流程，

1. 它接收两个参数，`row`和`edit`，`row`是传递的行数据，`edit`是一个布尔值，用于标记流程是否可编辑。
2. `this.$router.push()`: 用于进行页面跳转。它会跳转到指定的路由，并携带参数。
3. `path: '/flowable/task/record/index/kevin_leave/' + this.getListRowIdForTab('kevin_leave')`: 这是跳转的路径部分，其中`/flowable/task/record/index/kevin_leave/`是固定的路径，而`this.getListRowIdForTab('kevin_leave')`是通过调用`getListRowIdForTab`方法获取的一个值，将其拼接在路径后面。
4. `query: {}`: 这是携带的查询参数对象，用于向目标路由传递参数。在这里，`procDefKey`、`businessId`、`businessKey`、`workflowDataId`、`editable`都是键值对，用于传递相应的参数值。







## 新增请假页面

将之前拷贝的文件夹中的请假页面的vue文件和js文件可以先粘到自己的文件夹下，然后根据自己数据库的字段进行修改即可

index.vue对应的js文件中包含数据库中的字段和新增的工单状态、流程id、流程key三个字段。

自己新增的请假页面对应的js文件中只包含数据库中的字段



以下面这个字段为例：

```json
{
      "type": "datetimerange",
      "label": "请假日期",
      "prop": "leaveDate",
      span: 24,
      startPlaceholder: "开始时间",
      endPlaceholder: "结束时间",
      format: 'yyyy-MM-dd HH:mm:ss',
      valueFormat: 'yyyy-MM-dd HH:mm:ss'
 }, 
```

1. `"type": "datetimerange"`：这个字段是一个日期时间范围选择器，用户可以通过它选择一个起始时间和一个结束时间。这个字段在后台数据库中对应的是一个String类型的数组：["2023-07-28 00:00:00","2023-07-31 00:00:00"]   
2. `"label": "请假日期"`：在页面上显示的文本标签，这里显示为"请假日期"。
3. `"prop": "leaveDate"`：这个日期时间范围选择器的属性名称，它对应后端生成代码中entiy包下的实体类中的leaveDate这个字段。当用户选择日期时间范围后，选择的值会以"leaveDate"为字段名传递给后台。
4. `startPlaceholder: "开始时间"`：在起始时间输入框为空时显示的提示文本。
5. `endPlaceholder: "结束时间"`：在结束时间输入框为空时显示的提示文本。
6. `format: 'yyyy-MM-dd HH:mm:ss'`：在页面上显示的日期时间格式。
7. `valueFormat: 'yyyy-MM-dd HH:mm:ss'`：在后台接收的日期时间格式。





在index.vue页面中，里面的getList()方法要重写成自己的方法

```json
getList(page, params) {
      this.tableLoading = true
      flowList(Object.assign({
        current: page.currentPage,
        size: page.pageSize
      }, params, this.searchForm)).then(response => {
        this.tableData = response.data.records
        this.page.total = response.data.total
        this.tableLoading = false
      }).catch(() => {
        this.tableLoading = false
      })
  },
```

这个方法的作用是在获取列表数据时，将数据加载状态先置为true，并调用flowList()方法，将请求返回的列表数据赋值给`this.tableData`，同时更新分页中的总数据量，并在数据加载完成后取消加载状态的显示。



这个flowList方法用于发送HTTP请求，请求方式为get，请求的url地址是：`/vsn-kevin/kevinleave/kevinLeaveWorkFlowPage`

这个url地址会映射到后端controller中的具体方法

```json
export function flowList(query) {
  return request({
    url: '/vsn-kevin/kevinleave/kevinLeaveWorkFlowPage',
    method: 'get',
    params: query
  })
}
```





```java
	@GetMapping("/kevinLeaveWorkFlowPage" )
	@PreAuthorize("@pms.hasPermission('kevin_kevinleave_apply')")
	@SysLog("请假申请工单查询")
	public R getKevinLeaveWorkFlowPage(Page page, KevinLeaveWorkFlowVO kevinLeaveWorkFlowVO){
		IPage<KevinLeaveWorkFlowVO> kevinLeaveWorkFlowPage = kevinLeaveService.getKevinLeaveWorkFlowPage(page, kevinLeaveWorkFlowVO);
		return R.ok(kevinLeaveWorkFlowPage);
	}
```

这个方法中的`@PreAuthorize("@pms.hasPermission('kevin_kevinleave_apply')")`是一个Spring Security中的注解，用于进行权限控制。`@pms.hasPermission('kevin_kevinleave_apply')`表示用户需要具有"kevin_kevinleave_apply"权限才能访问这个方法。如果用户没有权限，将会被拦截，并返回403 Forbidden错误。



这个`kevin_kevinleave_apply`就是用户在前台系统中菜单管理里面按钮的权限标识

![image-20230722111039334](C:/Users/Lenovo/AppData/Roaming/Typora/typora-user-images/image-20230722111039334.png)









## 定时任务

本项目中定时任务使用的是：xxl-job。xxl-job是一个基于Java的分布式定时任务调度框架，用于在分布式系统中执行定时任务。

工作原理：

1. 定时任务被配置到`xxl-job`的任务调度中心。
2. 调度中心按照预定的时间触发任务的执行，将任务发送给指定的执行器。
3. 执行器接收到任务后，执行任务的具体逻辑，并将执行结果返回给调度中心。
4. 调度中心根据任务的执行结果，更新任务的状态和执行日志。



